import { test, expect } from './helpers/setup'

/**
 * US-101: Notes List Redesign - E2E Tests
 * 
 * Tests the Bear-like redesign of the notes list panel including:
 * - Toolbar with new/sort/filter icons
 * - Sort dropdown functionality
 * - Filter bar with tag chips
 * - Note items with Bear styling
 */

test.describe('US-101: Notes List Redesign @e2e', () => {
  test.beforeEach(async ({ page }) => {
    // Wait for app to be ready
    await page.waitForSelector('[data-testid="notes-list"]', { timeout: 10000 })
  })

  test.describe('@smoke - Layout & Structure', () => {
    test('notes list container displays with correct layout', async ({ page }) => {
      const notesList = page.locator('[data-testid="notes-list-container"]')
      await expect(notesList).toBeVisible()

      // Check panel is positioned between sidebar and editor
      const boundingBox = await notesList.boundingBox()
      expect(boundingBox).toBeTruthy()
      expect(boundingBox!.width).toBeGreaterThanOrEqual(280)
      expect(boundingBox!.width).toBeLessThanOrEqual(320)
    })

    test('dark mode background colors are correct', async ({ page }) => {
      // Enable dark mode
      await page.click('[data-testid="theme-toggle"]')
      await page.waitForTimeout(500)

      const notesList = page.locator('[data-testid="notes-list-container"]')
      const bgColor = await notesList.evaluate((el) => 
        window.getComputedStyle(el).backgroundColor
      )

      // #1C1C1E = rgb(28, 28, 30)
      expect(bgColor).toBe('rgb(28, 28, 30)')
    })
  })

  test.describe('@smoke - Toolbar', () => {
    test('toolbar displays correctly with all icons', async () => {
    const { page } = arguments[0];
      const toolbar = page.locator('[data-testid="notes-list-toolbar"]')
      await expect(toolbar).toBeVisible()

      // Check height
      const height = await toolbar.evaluate((el) => el.offsetHeight)
      expect(height).toBe(36)

      // Check all icons are present
      await expect(page.locator('[data-testid="toolbar-new-note"]')).toBeVisible()
      await expect(page.locator('[data-testid="toolbar-sort"]')).toBeVisible()
      await expect(page.locator('[data-testid="toolbar-filter"]')).toBeVisible()
    })

    test('new note button creates note', async () => {
    const { page } = arguments[0];
      const initialCount = await page.locator('[data-testid="note-item"]').count()

      await page.click('[data-testid="toolbar-new-note"]')
      await page.waitForTimeout(500)

      const newCount = await page.locator('[data-testid="note-item"]').count()
      expect(newCount).toBe(initialCount + 1)

      // Check editor has focus
      const editorFocused = await page.evaluate(() => {
        const editor = document.querySelector('[data-testid="note-editor"]')
        return document.activeElement === editor || editor?.contains(document.activeElement)
      })
      expect(editorFocused).toBe(true)
    })
  })

  test.describe('@e2e - Sort Functionality', () => {
    test('sort by created date descending', async () => {
    const { page } = arguments[0];
      // Create notes with different dates
      await page.click('[data-testid="toolbar-new-note"]')
      await page.fill('[data-testid="note-editor"]', '# First Note')
      await page.waitForTimeout(500)

      await page.click('[data-testid="toolbar-new-note"]')
      await page.fill('[data-testid="note-editor"]', '# Second Note')
      await page.waitForTimeout(500)

      // Open sort dropdown
      await page.click('[data-testid="toolbar-sort"]')
      await expect(page.locator('[data-testid="sort-dropdown"]')).toBeVisible()

      // Select "Created date" and "Descending"
      await page.click('[data-testid="sort-option-created"]')
      await page.click('[data-testid="direction-option-desc"]')

      // Verify order
      const firstNote = page.locator('[data-testid="note-item"]').first()
      const firstTitle = await firstNote.locator('[data-testid="note-title"]').textContent()
      expect(firstTitle).toContain('Second Note')
    })

    test('sort by title ascending', async () => {
    const { page } = arguments[0];
      // Create notes with different titles
      await page.click('[data-testid="toolbar-new-note"]')
      await page.fill('[data-testid="note-editor"]', '# Zebra')
      await page.waitForTimeout(500)

      await page.click('[data-testid="toolbar-new-note"]')
      await page.fill('[data-testid="note-editor"]', '# Apple')
      await page.waitForTimeout(500)

      await page.click('[data-testid="toolbar-new-note"]')
      await page.fill('[data-testid="note-editor"]', '# Mango')
      await page.waitForTimeout(500)

      // Open sort dropdown
      await page.click('[data-testid="toolbar-sort"]')

      // Select "Title" and "Ascending"
      await page.click('[data-testid="sort-option-title"]')
      await page.click('[data-testid="direction-option-asc"]')

      // Verify order
      const notes = page.locator('[data-testid="note-item"]')
      const firstTitle = await notes.nth(0).locator('[data-testid="note-title"]').textContent()
      const secondTitle = await notes.nth(1).locator('[data-testid="note-title"]').textContent()
      const thirdTitle = await notes.nth(2).locator('[data-testid="note-title"]').textContent()

      expect(firstTitle).toContain('Apple')
      expect(secondTitle).toContain('Mango')
      expect(thirdTitle).toContain('Zebra')
    })
  })

  test.describe('@smoke - Filter Bar', () => {
    test('filter bar activates via search icon', async () => {
    const { page } = arguments[0];
      await page.click('[data-testid="toolbar-filter"]')

      const filterBar = page.locator('[data-testid="filter-bar"]')
      await expect(filterBar).toBeVisible()

      // Check toolbar icons are hidden
      await expect(page.locator('[data-testid="toolbar-new-note"]')).not.toBeVisible()

      // Check input has focus
      const inputFocused = await page.evaluate(() => {
        const input = document.querySelector('[data-testid="filter-input"]')
        return document.activeElement === input
      })
      expect(inputFocused).toBe(true)
    })

    test('filter bar activates via tag click in sidebar', async () => {
    const { page } = arguments[0];
      // Create a note with a tag
      await page.click('[data-testid="toolbar-new-note"]')
      await page.fill('[data-testid="note-editor"]', '# Work Note\n\n#work')
      await page.waitForTimeout(1000)

      // Click tag in sidebar
      await page.click('[data-testid="sidebar-tag-work"]')

      // Check filter bar auto-opens
      const filterBar = page.locator('[data-testid="filter-bar"]')
      await expect(filterBar).toBeVisible()

      // Check chip is displayed
      const chip = page.locator('[data-testid="chip-0"]')
      await expect(chip).toBeVisible()
      await expect(chip).toContainText('work')

      // Check tag is highlighted in sidebar
      const tag = page.locator('[data-testid="sidebar-tag-work"]')
      await expect(tag).toHaveClass(/selected/)
    })
  })

  test.describe('@e2e - Tag Chips', () => {
    test('converts "tag:xxx" to chip on Space', async () => {
    const { page } = arguments[0];
      await page.click('[data-testid="toolbar-filter"]')

      const input = page.locator('[data-testid="filter-input"]')
      await input.fill('tag:meeting')
      await input.press('Space')

      // Check chip is created
      const chip = page.locator('[data-testid="chip-0"]')
      await expect(chip).toBeVisible()
      await expect(chip).toContainText('meeting')

      // Check input is cleared
      const inputValue = await input.inputValue()
      expect(inputValue).toBe('')
    })

    test('removes chip on × button click', async () => {
    const { page } = arguments[0];
      await page.click('[data-testid="toolbar-filter"]')

      const input = page.locator('[data-testid="filter-input"]')
      await input.fill('tag:work')
      await input.press('Space')

      // Check chip exists
      await expect(page.locator('[data-testid="chip-0"]')).toBeVisible()

      // Click × button
      await page.click('[data-testid="chip-remove-0"]')

      // Check chip is removed
      await expect(page.locator('[data-testid="chip-0"]')).not.toBeVisible()
    })

    test('removes chip on Backspace when cursor after chip', async () => {
    const { page } = arguments[0];
      await page.click('[data-testid="toolbar-filter"]')

      const input = page.locator('[data-testid="filter-input"]')
      await input.fill('tag:work')
      await input.press('Space')

      // Check chip exists
      await expect(page.locator('[data-testid="chip-0"]')).toBeVisible()

      // Press Backspace
      await input.press('Backspace')

      // Check chip is removed
      await expect(page.locator('[data-testid="chip-0"]')).not.toBeVisible()
    })
  })

  test.describe('@smoke - Note Items Display', () => {
    test('note item displays all elements correctly', async () => {
    const { page } = arguments[0];
      // Create a note
      await page.click('[data-testid="toolbar-new-note"]')
      await page.fill('[data-testid="note-editor"]', '# Meeting Notes\n\nDiscussed project timeline and deliverables for Q1')
      await page.waitForTimeout(1000)

      const noteItem = page.locator('[data-testid="note-item"]').first()
      await expect(noteItem).toBeVisible()

      // Check title
      const title = noteItem.locator('[data-testid="note-title"]')
      await expect(title).toContainText('Meeting Notes')

      // Check preview
      const preview = noteItem.locator('[data-testid="note-preview"]')
      await expect(preview).toBeVisible()
      await expect(preview).toContainText('Discussed project timeline')

      // Check date
      const date = noteItem.locator('[data-testid="note-date"]')
      await expect(date).toBeVisible()
    })

    test('note item selection state', async () => {
    const { page } = arguments[0];
      // Create two notes
      await page.click('[data-testid="toolbar-new-note"]')
      await page.fill('[data-testid="note-editor"]', '# First Note')
      await page.waitForTimeout(500)

      await page.click('[data-testid="toolbar-new-note"]')
      await page.fill('[data-testid="note-editor"]', '# Second Note')
      await page.waitForTimeout(500)

      // Click first note
      const firstNote = page.locator('[data-testid="note-item"]').first()
      await firstNote.click()

      // Check selection state
      await expect(firstNote).toHaveClass(/selected/)

      // Check editor displays the note
      const editorContent = await page.locator('[data-testid="note-editor"]').textContent()
      expect(editorContent).toContain('First Note')
    })
  })

  test.describe('@e2e - Empty States', () => {
    test('empty notes list displays placeholder', async () => {
    const { page } = arguments[0];
      // Assuming fresh app with no notes
      const emptyState = page.locator('[data-testid="empty-state"]')
      
      if (await emptyState.isVisible()) {
        await expect(emptyState).toContainText('No notes yet')
        await expect(emptyState).toContainText('Click + to create your first note')
      }
    })

    test('empty filtered list displays message', async () => {
    const { page } = arguments[0];
      // Create a note without the tag we'll filter for
      await page.click('[data-testid="toolbar-new-note"]')
      await page.fill('[data-testid="note-editor"]', '# Note without tag')
      await page.waitForTimeout(500)

      // Filter by non-existent tag
      await page.click('[data-testid="toolbar-filter"]')
      const input = page.locator('[data-testid="filter-input"]')
      await input.fill('tag:nonexistent')
      await input.press('Space')

      // Check empty state
      const emptyState = page.locator('[data-testid="empty-filtered-state"]')
      await expect(emptyState).toBeVisible()
      await expect(emptyState).toContainText('No notes match your filter')
    })
  })

  test.describe('@integration - Keyboard Navigation', () => {
    test('navigates notes list with arrow keys', async () => {
    const { page } = arguments[0];
      // Create multiple notes
      for (let i = 1; i <= 3; i++) {
        await page.click('[data-testid="toolbar-new-note"]')
        await page.fill('[data-testid="note-editor"]', `# Note ${i}`)
        await page.waitForTimeout(300)
      }

      // Focus notes list
      await page.click('[data-testid="notes-list"]')

      // Press Arrow Down
      await page.keyboard.press('ArrowDown')
      await page.waitForTimeout(100)

      // Check second note is focused
      const secondNote = page.locator('[data-testid="note-item"]').nth(1)
      await expect(secondNote).toBeFocused()

      // Press Enter to open
      await page.keyboard.press('Enter')
      await page.waitForTimeout(100)

      // Check editor displays the note
      const editorContent = await page.locator('[data-testid="note-editor"]').textContent()
      expect(editorContent).toContain('Note 2')
    })
  })

  test.describe('@integration - Scroll Behavior', () => {
    test('scroll position persists on note selection', async () => {
    const { page } = arguments[0];
      // Create many notes
      for (let i = 1; i <= 20; i++) {
        await page.click('[data-testid="toolbar-new-note"]')
        await page.fill('[data-testid="note-editor"]', `# Note ${i}`)
        await page.waitForTimeout(100)
      }

      const notesList = page.locator('[data-testid="notes-list"]')

      // Scroll to middle
      await notesList.evaluate((el) => {
        el.scrollTop = el.scrollHeight / 2
      })

      const scrollBefore = await notesList.evaluate((el) => el.scrollTop)

      // Click a note
      const middleNote = page.locator('[data-testid="note-item"]').nth(10)
      await middleNote.click()
      await page.waitForTimeout(100)

      // Check scroll position is maintained
      const scrollAfter = await notesList.evaluate((el) => el.scrollTop)
      expect(scrollAfter).toBe(scrollBefore)
    })

    test('scrolls to top on new note creation', async () => {
    const { page } = arguments[0];
      // Create many notes
      for (let i = 1; i <= 20; i++) {
        await page.click('[data-testid="toolbar-new-note"]')
        await page.fill('[data-testid="note-editor"]', `# Note ${i}`)
        await page.waitForTimeout(100)
      }

      const notesList = page.locator('[data-testid="notes-list"]')

      // Scroll to bottom
      await notesList.evaluate((el) => {
        el.scrollTop = el.scrollHeight
      })

      // Create new note
      await page.click('[data-testid="toolbar-new-note"]')
      await page.waitForTimeout(500)

      // Check scroll is at top
      const scrollTop = await notesList.evaluate((el) => el.scrollTop)
      expect(scrollTop).toBe(0)
    })
  })
})
